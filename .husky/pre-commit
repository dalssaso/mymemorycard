#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "Running pre-commit checks..."

# Run lint-staged for formatting and linting
npx lint-staged

# Check for emojis in code (excluding UI files)
echo "Checking for emojis in code..."
STAGED_FILES=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | grep -v 'frontend/src/pages\|frontend/src/components/ui' || true)

if [ -n "$STAGED_FILES" ]; then
    for FILE in $STAGED_FILES; do
        if grep -q '[ðŸ˜€-ðŸ™ðŸŒ€-ðŸ—¿ðŸš€-ðŸ›¿]' "$FILE" 2>/dev/null; then
            echo "ERROR: Emojis found in $FILE"
            echo "Emojis are only allowed in UI components (frontend/src/pages, frontend/src/components/ui)"
            exit 1
        fi
    done
fi

# Run quick backend tests (only if backend files changed)
BACKEND_CHANGED=$(git diff --cached --name-only | grep '^backend/' || true)
if [ -n "$BACKEND_CHANGED" ]; then
    echo "Running backend tests..."
    cd backend && bun test || exit 1
    cd ..
fi

# Run quick frontend tests (only if frontend files changed)
FRONTEND_CHANGED=$(git diff --cached --name-only | grep '^frontend/' || true)
if [ -n "$FRONTEND_CHANGED" ]; then
    echo "Running frontend tests..."
    cd frontend && npm test -- --run || exit 1
    cd ..
fi

echo "All pre-commit checks passed!"
