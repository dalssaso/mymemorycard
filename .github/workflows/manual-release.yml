name: Manual Prerelease

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to release'
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both
      versionBump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      prereleaseType:
        description: 'Prerelease type'
        required: true
        type: choice
        options:
          - alpha
          - beta
          - rc
      prereleaseId:
        description: 'Prerelease number (default: 1)'
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  prepare:
    name: Prepare Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Set matrix
        id: set-matrix
        run: |
          if [ "${{ inputs.component }}" = "both" ]; then
            echo 'matrix=["backend","frontend"]' >> $GITHUB_OUTPUT
          else
            echo "matrix=[\"${{ inputs.component }}\"]" >> $GITHUB_OUTPUT
          fi

  prerelease:
    name: Prerelease ${{ matrix.component }}
    runs-on: ubuntu-latest
    needs: prepare
    strategy:
      matrix:
        component: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: mymemorycard
          POSTGRES_PASSWORD: devpassword
          POSTGRES_DB: mymemorycard
        ports:
          - 5433:5432
        options: >-
          --health-cmd="pg_isready -U mymemorycard"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7-alpine
        ports:
          - 6380:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=3s
          --health-retries=5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Compute prerelease version
        id: version
        run: |
          python - <<'PY'
          import json
          import os

          component = os.environ["COMPONENT"]
          bump = os.environ["BUMP"]
          prerelease = os.environ["PRERELEASE"]
          prerelease_id = os.environ.get("PRERELEASE_ID") or "1"

          with open(".release-please-manifest.json") as f:
            manifest = json.load(f)

          base = manifest[component]
          parts = base.split("-")[0].split(".")
          major, minor, patch = [int(p) for p in parts]

          if bump == "major":
            major += 1
            minor = 0
            patch = 0
          elif bump == "minor":
            minor += 1
            patch = 0
          else:
            patch += 1

          version = f"{major}.{minor}.{patch}-{prerelease}.{prerelease_id}"
          tag = f"{component}-v{version}"

          print(f"version={version}")
          print(f"tag={tag}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"version={version}\n")
            f.write(f"tag={tag}\n")
          PY
        env:
          COMPONENT: ${{ matrix.component }}
          BUMP: ${{ inputs.versionBump }}
          PRERELEASE: ${{ inputs.prereleaseType }}
          PRERELEASE_ID: ${{ inputs.prereleaseId }}

      - name: Setup Bun
        if: ${{ matrix.component == 'backend' }}
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Setup Node.js
        if: ${{ matrix.component == 'frontend' }}
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install backend dependencies
        if: ${{ matrix.component == 'backend' }}
        working-directory: ./backend
        run: bun install --frozen-lockfile

      - name: Install frontend dependencies
        if: ${{ matrix.component == 'frontend' }}
        working-directory: ./frontend
        run: npm ci

      - name: Run backend tests
        if: ${{ matrix.component == 'backend' }}
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://mymemorycard:devpassword@localhost:5433/mymemorycard
          REDIS_URL: redis://localhost:6380
          JWT_SECRET: ci-jwt-secret-change-in-production-32chars-min
          ENCRYPTION_SECRET: ci-encryption-secret-change-in-production-32chars-min
          ENCRYPTION_SALT: ci-encryption-salt-min-16
          RAWG_API_KEY: ci-rawg-api-key
        run: bun run test

      - name: Run frontend tests
        if: ${{ matrix.component == 'frontend' }}
        working-directory: ./frontend
        run: npm test

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.component }}
          file: ./${{ matrix.component }}/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}/${{ matrix.component }}:${{ steps.version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Create prerelease
        uses: softprops/action-gh-release@v2
        with:
          prerelease: true
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
